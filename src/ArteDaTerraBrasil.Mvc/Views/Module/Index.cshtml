@using ArteDaTerraBrasil.Mvc.ViewModels.Parameters
@model IEnumerable<ModuleViewModel>

@{
    ViewData["Title"] = "Módulos";
    ViewData["Section"] = "Gestão de Utilizadores";
}

<!-- Keep only external plugin styles that are NOT part of your local wwwroot -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.datatables.net/2.2.2/css/dataTables.bootstrap5.css" rel="stylesheet" />
<link href="~/css/site.css" rel="stylesheet" />

<p supress-by-module-tag="module" supress-by-claim-tag="adicionar">
    <a class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#createModal" data-action="open-create-role"><i class="fa fa-plus"></i> Adicionar</a>
</p>

<partial name="_ModuleList" />
<partial supress-by-module-tag="module" supress-by-claim-tag="adicionar" name="_ModalCreate" />
<partial name="_ModalDetails" />
<partial supress-by-module-tag="module" supress-by-claim-tag="editar" name="_ModalEdit" />

@section Scripts {
    <!-- jQuery and plugin dependencies -->
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <script src="https://cdn.datatables.net/2.2.2/js/dataTables.js"></script>
    <script src="https://cdn.datatables.net/2.2.2/js/dataTables.bootstrap5.js"></script>

    <!-- Bootstrap Datepicker -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>

    <!-- FontAwesome -->
    <script src="https://kit.fontawesome.com/a076d05399.js"></script>

    <!-- Toastr -->
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        #toast-container > .toast {
            white-space: nowrap;
            max-width: none;
            width: auto;
            word-wrap: normal;
        }
    </style>

    <script>

            toastr.options = {
            positionClass: 'toast-top-right', // Posição no canto superior direito
            preventDuplicates: true, // Evita mensagens duplicadas
            closeButton: true, // Botão para fechar manualmente
            progressBar: true, // Barra de progresso para o tempo de exibição
            timeOut: 2000, // Tempo para desaparecer (em milissegundos)
            extendedTimeOut: 3000, // Tempo adicional ao passar o mouse
            showDuration: 300, // Velocidade da animação ao exibir
            hideDuration: 300, // Velocidade da animação ao esconder
        }

        $(document).ready(function () {

            var baseUrl = "@Url.Content("~")";

        let savedPageLength = localStorage.getItem('datatable_page_length') || 10; // Default to 10 if not set

        $('#Table').DataTable({
            "paging": true,
            "pageLength": parseInt(savedPageLength),
            "lengthChange": true,
            "searching": true,
            "ordering": true,
            "info": true,
            "autoWidth": true,
            "responsive": true,
            "language": {
                "search": "Pesquisar:",
                "paginate": {
                    "previous": "Anterior",
                    "next": "Próximo"
                },
                "lengthMenu": "Mostrar _MENU_ registros por página",
                "zeroRecords": "Nenhum registro encontrado",
                "info": "Mostrando _START_ a _END_ de _TOTAL_ registros",
                "infoEmpty": "Nenhum registro disponível",
                "infoFiltered": "(filtrado de _MAX_ registros no total)"
            },
            "columnDefs": [
                { "orderable": false, "targets": -1 } // Desabilita a ordenação para a última coluna
            ],
            "lengthMenu": [[5, 10, 25, 50, -1], [5, 10, 25, 50, "Todos"]],
        }).on('length.dt', function (e, settings, len) {
            localStorage.setItem('datatable_page_length', len);
        });

            // Function to open a modal and load content dynamically
        function openModal(modalId, url, data = {}) {
            var modal = new bootstrap.Modal(document.getElementById(modalId)); // Initialize the modal
            $.ajax({
                url: url,
                type: 'GET',
                data: data, // You can pass additional data if needed
                success: function (response) {
                    $('#' + modalId).find('.modal-body').html(response); // Populate the modal body with content
                    modal.show(); // Show the modal after content is loaded
                },
                error: function () {
                    Swal.fire({
                        allowOutsideClick: false,
                        icon: 'error',
                        text: 'Erro ao carregar os dados.'
                    });
                }
            });
        }

        //Fechar modal direito
        document.addEventListener('hidden.bs.modal', function (event) {
            $('.modal-backdrop').remove();
            $('body').removeClass('modal-open').css('padding-right', '0');
        });

        // Open Create Modal
        $('a[data-bs-toggle="modal"][data-bs-target="#createModal"]').on('click', function () {
            console.log("Opened create module modal");
            openModal('createModal', baseUrl + '/Module-Create/'); // Adjust URL as needed
        });

        // Save Create Modal Data
        $('#createSaveButton').on('click', function () {
            var formData = $('#CreateForm').serialize(); // Serialize the form data
            console.log(formData);
            $.ajax({
                url: baseUrl + '/Module-Create/', // Adjust URL for creating
                type: 'POST',
                data: formData,
                success: function (response) {
                    if (response.success) {
                        toastr.success(response.message);
                        setTimeout(function () { location.reload(); }, 3000);
                    } else {
                        toastr.error(response.errors);
                    }
                },
                error: function () {
                    toastr.error('Erro ao salvar dados.');
                }
            });
        });

        // Open Edit Modal
        $(document).on('click', '[data-bs-toggle="modal"][data-bs-target="#editModal"]', function () {
            id = $(this).data('id'); // Store the ID globally or in the modal if preferred
            openModal('editModal', baseUrl + '/Module-Edit/' + id); // Adjust URL as needed
        });

        // Save Edit Modal Data
        $('#editSaveButton').on('click', function () {
            var formData = $('#EditForm').serialize(); // Serialize the form data

            if (!id) {
                toastr.error('ID não encontrado para edição.');
                return;
            }

            $.ajax({
                url: baseUrl + '/Module-Edit/'+id, // Adjust URL for editing
                type: 'POST',
                data: formData,
                success: function (response) {
                    if (response.success) {
                        toastr.success(response.message);
                        setTimeout(function () { location.reload(); }, 1000);
                    } else {
                        toastr.error(response.errors);
                    }
                },
                error: function () {
                    toastr.error('Erro ao salvar dados.');
                    console.log(response.error);
                }
            });
        });

        // Open Details Modal
        $(document).on('click', '[data-bs-toggle="modal"][data-bs-target="#detailsModal"]', function () {
            var id = $(this).data('id'); // Get the ID from data-id attribute
            openModal('detailsModal', baseUrl + '/Module-Details/' + id); // Adjust URL as needed
        });

        $(document).on('click', '[data-bs-target="#delete"]', function () {
                var button = $(this);
                var id = button.data('id');
                var name = button.data('name');

                Swal.fire({
                    title: 'Tem certeza que deseja excluir?',
                    text: `Módulo: ${name}`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Sim',
                    cancelButtonText: 'Não',
                    allowOutsideClick: false
                }).then((result) => {
                    if (result.isConfirmed) {
                        Swal.fire({
                            title: 'Aguarde...',
                            text: 'Processando sua solicitação de exclusão.',
                            allowOutsideClick: false,
                            didOpen: () => {
                                Swal.showLoading();
                            }
                        });

                        $.ajax({
                            url: baseUrl + '/Module-Remove/' + id, // Endpoint de exclusão
                            type: 'POST',
                            data: {
                                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                            },
                            success: function (response) {
                                if (response.success) {

                                    toastr.success(response.message);

                                    setTimeout(function () { location.reload(); }, 1000);

                                } else {

                                    if (Array.isArray(response.errors)) {
                                        response.errors.forEach(function (error) { toastr.error(error); });
                                    } else if (typeof response.errors === 'string') {
                                        toastr.error(response.errors);
                                    } else {
                                        toastr.error('Não foi possivel obter o erro do backend!');
                                    }
                                }
                                Swal.close(); // Fecha o modal de loading

                            },
                            error: function () {
                            Swal.close(); // Fecha o modal de loading
                            toastr.error('Ocorreu um erro ao submeter sua solicitação para URL! ');

                            setTimeout(function () { Swal.close(); }, 1000);

                            }
                        });
                    }
                });
            }); // Fim Remove (.btn-danger)

            $(document).on('click', '[data-bs-target="#activate"]', function () {
                var button = $(this);
                var id = button.data('id');
                var name = button.data('name');

                Swal.fire({
                    title: 'Tem certeza que deseja reativar?',
                    text: `Módulo: ${name}`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Sim',
                    cancelButtonText: 'Não',
                    allowOutsideClick: false
                }).then((result) => {
                    if (result.isConfirmed) {
                        Swal.fire({
                            title: 'Aguarde...',
                            text: 'Processando sua solicitação de exclusão.',
                            allowOutsideClick: false,
                            didOpen: () => {
                                Swal.showLoading();
                            }
                        });

                        $.ajax({
                            url: baseUrl + '/Module-Activate/' + id, // Endpoint de exclusão
                            type: 'POST',
                            data: {
                                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                            },
                            success: function (response) {
                                if (response.success) {

                                    toastr.success(response.message);

                                    setTimeout(function () { location.reload(); }, 1000);

                                } else {

                                    if (Array.isArray(response.errors)) {
                                        response.errors.forEach(function (error) { toastr.error(error); });
                                    } else if (typeof response.errors === 'string') {
                                        toastr.error(response.errors);
                                    } else {
                                        toastr.error('Não foi possivel obter o erro do backend!');
                                    }
                                }
                                Swal.close(); // Fecha o modal de loading

                            },
                            error: function () {
                            Swal.close(); // Fecha o modal de loading
                            toastr.error('Ocorreu um erro ao submeter sua solicitação para URL! ');

                            setTimeout(function () { Swal.close(); }, 1000);

                            }
                        });
                    }
                });
            }); // Fim Remove (.btn-danger)

        }); // Fim document ready

    </script>
}
