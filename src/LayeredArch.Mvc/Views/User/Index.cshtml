@using LayeredArch.Mvc.ViewModels.Entities
@model IEnumerable<UserViewModel>

@{
    ViewData["Title"] = "Utilizadores";
    ViewData["Section"] = "Gestão de Utilizadores";
}

<!-- Keep only external plugin styles that are NOT part of your local wwwroot -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.datatables.net/2.2.2/css/dataTables.bootstrap5.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<link href="~/css/site.css" rel="stylesheet" />

<partial name="_UserList" />
<partial name="_ModalDetails" />
<partial supress-by-module-tag="user" supress-by-claim-tag="editar" name="_ModalEdit" />

@section Scripts {
    <!-- jQuery and plugin dependencies -->
    <script src="https://code.jquery.com/jquery-3.7.1.js"
            integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="
            crossorigin="anonymous"></script>
    <script src="https://cdn.datatables.net/2.2.2/js/dataTables.js"></script>
    <script src="https://cdn.datatables.net/2.2.2/js/dataTables.bootstrap5.js"></script>

    <!-- Bootstrap Datepicker -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>

    <!-- FontAwesome -->
    <script src="https://kit.fontawesome.com/a076d05399.js"></script>

    <!-- Toastr -->
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!--Select 2-->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <style>
        #toast-container > .toast {
            white-space: nowrap;
            max-width: none;
            width: auto;
            word-wrap: normal;
        }
    </style>

    <script>

            toastr.options = {
            positionClass: 'toast-top-right', // Posição no canto superior direito
            preventDuplicates: true, // Evita mensagens duplicadas
            closeButton: true, // Botão para fechar manualmente
            progressBar: true, // Barra de progresso para o tempo de exibição
            timeOut: 2000, // Tempo para desaparecer (em milissegundos)
            extendedTimeOut: 3000, // Tempo adicional ao passar o mouse
            showDuration: 300, // Velocidade da animação ao exibir
            hideDuration: 300, // Velocidade da animação ao esconder
        }

        $(document).ready(function () {

        var baseUrl = "@Url.Content("~")";

        let savedPageLength = localStorage.getItem('datatable_page_length') || 10; // Default to 10 if not set

        $('#Table').DataTable({
            "paging": true,
            "pageLength": parseInt(savedPageLength),
            "lengthChange": true,
            "searching": true,
            "ordering": true,
            "info": true,
            "autoWidth": true,
            "responsive": true,
            "language": {
                "search": "Pesquisar:",
                "paginate": {
                    "previous": "Anterior",
                    "next": "Próximo"
                },
                "lengthMenu": "Mostrar _MENU_ registros por página",
                "zeroRecords": "Nenhum registro encontrado",
                "info": "Mostrando _START_ a _END_ de _TOTAL_ registros",
                "infoEmpty": "Nenhum registro disponível",
                "infoFiltered": "(filtrado de _MAX_ registros no total)"
            },
            "columnDefs": [
                { "orderable": false, "targets": -1 } // Desabilita a ordenação para a última coluna
            ],
            "lengthMenu": [[5, 10, 25, 50, -1], [5, 10, 25, 50, "Todos"]],
        }).on('length.dt', function (e, settings, len) {
            localStorage.setItem('datatable_page_length', len);
        });

        function openModal(modalId, url, data = {}) {
            const $modalEl = $('#' + modalId);
            const bsModal   = new bootstrap.Modal($modalEl[0]);

            $.get(url, data).done(html => {
                $modalEl.find('.modal-body').html(html);

                // inicializa todos os <select> encontrados já com dropdown dentro da modal
                $modalEl.find('select').each(function () {
                    $(this).select2({
                        width: '100%',
                        dropdownParent: $modalEl        // <── aqui está o truque
                    });
                });

                bsModal.show();
            }).fail(() => {
                Swal.fire({icon:'error', text:'Erro ao carregar os dados.', allowOutsideClick:false});
            });
        }

         //Fechar modal direito
        document.addEventListener('hidden.bs.modal', function (event) {
            $('.modal-backdrop').remove();
            $('body').removeClass('modal-open').css('padding-right', '0');
        });

        // Open Edit Modal
        $(document).on('click', '[data-bs-toggle="modal"][data-bs-target="#editModal"]', function () {
            id = $(this).data('id'); // Store the ID globally or in the modal if preferred
            openModal('editModal', baseUrl + '/User-Edit/' + id); // Adjust URL as needed
        });

        // Save Edit Modal Data
        $('#editSaveButton').on('click', function () {
            var formData = $('#EditForm').serialize(); // Serialize the form data

            if (!id) {
                toastr.error('ID não encontrado para edição.');
                return;
            }

            $.ajax({
                url: baseUrl + '/User-Edit/'+id, // Adjust URL for editing
                type: 'POST',
                data: formData,
                success: function (response) {
                    if (response.success) {
                        toastr.success(response.message);
                        setTimeout(function () { location.reload(); }, 1000);
                    } else {
                        toastr.error(response.errors);
                    }
                },
                error: function () {
                    toastr.error('Erro ao salvar dados.');
                    console.log(response.error);
                }
            });
        });

        // Open Details Modal
        $(document).on('click', '[data-bs-toggle="modal"][data-bs-target="#detailsModal"]', function () {
            var id = $(this).data('id'); // Get the ID from data-id attribute
            openModal('detailsModal',baseUrl + '/User-Details/' + id); // Adjust URL as needed
        });

        $(document).on('click', '[data-bs-target="#delete"]', function () {
                var button = $(this);
                var id = button.data('id');
                var name = button.data('name');

                Swal.fire({
                    title: 'Tem certeza que deseja excluir?',
                    text: `Utilizador: ${name}`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Sim',
                    cancelButtonText: 'Não',
                    allowOutsideClick: false
                }).then((result) => {
                    if (result.isConfirmed) {
                        Swal.fire({
                            title: 'Aguarde...',
                            text: 'Processando sua solicitação de exclusão.',
                            allowOutsideClick: false,
                            didOpen: () => {
                                Swal.showLoading();
                            }
                        });

                        $.ajax({
                            url: baseUrl + '/User-Remove/' + id, // Endpoint de exclusão
                            type: 'POST',
                            data: {
                                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                            },
                            success: function (response) {
                                if (response.success) {

                                    toastr.success(response.message);

                                    setTimeout(function () { location.reload(); }, 1000);

                                } else {

                                    if (Array.isArray(response.errors)) {
                                        response.errors.forEach(function (error) { toastr.error(error); });
                                    } else if (typeof response.errors === 'string') {
                                        toastr.error(response.errors);
                                    } else {
                                        toastr.error('Não foi possivel obter o erro do backend!');
                                    }
                                }
                                Swal.close(); // Fecha o modal de loading

                            },
                            error: function () {
                            Swal.close(); // Fecha o modal de loading
                            toastr.error('Ocorreu um erro ao submeter sua solicitação para URL! ');

                            setTimeout(function () { Swal.close(); }, 1000);

                            }
                        });
                    }
                });
            }); // Fim Remove (.btn-danger)

            $(document).on('click', '[data-bs-target="#activate"]', function () {
                var button = $(this);
                var id = button.data('id');
                var name = button.data('name');

                Swal.fire({
                    title: 'Tem certeza que deseja reativar?',
                    text: `Utilizador: ${name}`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Sim',
                    cancelButtonText: 'Não',
                    allowOutsideClick: false
                }).then((result) => {
                    if (result.isConfirmed) {
                        Swal.fire({
                            title: 'Aguarde...',
                            text: 'Processando sua solicitação de exclusão.',
                            allowOutsideClick: false,
                            didOpen: () => {
                                Swal.showLoading();
                            }
                        });

                        $.ajax({
                            url: baseUrl + '/User-Activate/' + id, // Endpoint de exclusão
                            type: 'POST',
                            data: {
                                __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                            },
                            success: function (response) {
                                if (response.success) {

                                    toastr.success(response.message);

                                    setTimeout(function () { location.reload(); }, 1000);

                                } else {

                                    if (Array.isArray(response.errors)) {
                                        response.errors.forEach(function (error) { toastr.error(error); });
                                    } else if (typeof response.errors === 'string') {
                                        toastr.error(response.errors);
                                    } else {
                                        toastr.error('Não foi possivel obter o erro do backend!');
                                    }
                                }
                                Swal.close(); // Fecha o modal de loading

                            },
                            error: function () {
                            Swal.close(); // Fecha o modal de loading
                            toastr.error('Ocorreu um erro ao submeter sua solicitação para URL! ');

                            setTimeout(function () { Swal.close(); }, 1000);

                            }
                        });
                    }
                });
            }); // Fim Remove (.btn-danger)

        }); // Fim document ready

    </script>
}
